# Enable profiling
zmodload zsh/zprof

# Source configuration files
for conffile in "$ZSHDIR"/rc.d/*; do
    source $conffile
done

# iTerm2 integration
source "$ZSHDIR/plugins/iterm2_integration.zsh"

# Make spark availiable withoud adding it to PATH
alias spark="$DOTFILES/tools/spark/spark"

# Enable mysqltuner without installing it to the PATH
if (( $+commands[perl] )); then
    alias mysqltuner="$DOTFILES/tools/MySQLTuner-perl/mysqltuner.pl"
fi

# Enable mongo-hacker without symlink in home
if [[ -f "$DOTFILES/tools/mongo-hacker/mongo_hacker.js" ]]; then
    mongo() { command mongo "$@" --shell --norc "$DOTFILES/tools/mongo-hacker/mongo_hacker.js"; }
fi

# Transfer to root user's Xauth cookies
if [[ `whoami` = root ]] && [[ -n "$SSH_CLIENT" ]] && [[ -n "$SUDO_USER" ]] && [[ -n "$DISPLAY" ]]; then
    display=`echo $DISPLAY | cut -d':' -f 2 | cut -d'.' -f 1`
    cred=`su - $SUDO_USER -c "xauth list" | grep $display`
    echo $cred | xargs -n 3 xauth add
fi

# Allow root to use my DISPLAY (only on linux for now)
if [[ -n "$DISPLAY" ]] && [[ `uname -s` != "Darwin" ]] && (( $+commands[xhost] )); then
    xhost +si:localuser:root 2>&1 1>/dev/null
fi

# Force path arrays to have unique values only
typeset -U path cdpath fpath manpath

# Enable autoenv plugin
source "$ZSHDIR/plugins/autoenv/autoenv.zsh"

# Autoparis plugin
source "$ZSHDIR/plugins/autopair/autopair.zsh"

# Highlighting plugin
source "$ZSHDIR/plugins/syntax-highlighting/zsh-syntax-highlighting.zsh"
ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets pattern cursor)

# cdr plugin
ZSH_CDR_DIR="$XDG_CACHE_HOME/zsh"
source "$ZSHDIR/plugins/cdr/cdr.plugin.zsh"

# zaw plugin
source "$ZSHDIR/plugins/zaw/zaw.zsh"
bindkey '^R' zaw-history

# History substring search plugin
source "$ZSHDIR/plugins/history-substring-search/zsh-history-substring-search.zsh"
HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND='bg=green,fg=white'
bindkey "${key[Up]}"   history-substring-search-up
bindkey "${key[Down]}" history-substring-search-down

# Autosuggestions plugin
source "$ZSHDIR/plugins/autosuggestions/zsh-autosuggestions.zsh"
# Hack to init zsh-asug only once
# https://github.com/zsh-users/zsh-autosuggestions/issues/136#issuecomment-196640897
_zsh_autosuggest_start () {
    add-zsh-hook -d precmd _zsh_autosuggest_start
    _zsh_autosuggest_check_deprecated_config
    _zsh_autosuggest_bind_widgets
}

# Attach to a tmux session, if there's any. Do this only for remote SSH
# sessions, don't mess local tmux sessions.
if (( $+commands[tmux] )) && [[ -z "$TMUX" ]] && pgrep -U `whoami` tmux && [[ -n "$SSH_TTY" ]] && [[ -z "$MC_SID" ]]; then
    tmux attach
fi
